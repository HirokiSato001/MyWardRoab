<ons-page id="coordinateDtl">

	<head>
		<ons-toolbar>
			<div class="left">
				<ons-back-button>Back</ons-back-button>
			</div>
			<div class="center">
				<ons-icon icon="user-circle"></ons-icon>コーディネート詳細画面</div>
		</ons-toolbar>
	</head>

	<body>

		<div>
			<p class="box" style="border-bottom: 2px solid blue; color: black; border-color:black; text-align:center;">
				<font face="fantasy" size="5"> COORDINATE </font>
			</p>
			<table border="0" style="margin-left: auto; margin-right: auto;">
				<tr>
					<td colspan="1" rowspan="2">
						<!-- トップス -->
						<input id="tops_image" type="image" width="100" height="100">
					</td>
					<td colspan="1" rowspan="3">
						<!-- アウター -->
						<input id="outer_image" type="image" width="100" height="100">
					</td>
					<td colspan="1" rowspan="6" width="5" valign="top">
						<div style="text-align: center">
							<input type="checkbox" id="coordinatefvrtFlg" style="display:none;" value="1" onChange="changeCoordinateFvrt()">
							<div style="font-size: 30px;">
								<label for="coordinatefvrtFlg" class="center"><font id="coordinateStar" color="#c0c0c0">★</font></label>
							</div>
						</div>
					</td>
				</tr>
				<tr></tr>
				<tr>
					<td colspan="1" rowspan="2">
						<!-- ボトムス -->
						<input id="bottoms_image" type="image" width="100" height="100">
					</td>
				</tr>
				<tr>
					<td colspan="1" rowspan="3"></td>
				</tr>
				<tr>
					<td colspan="1" rowspan="2">
						<!-- 靴 -->
						<input id="shoes_image" type="image" width="100" height="100">
					</td>
				</tr>
			</table>

		</div>
		<div>
			<p class="box" style="border-top: 2px solid blue; color: black; border-color:black; text-align:center;">
				<font face="fantasy" size="5"> ITEM LIST </font>
			</p>

			<table border="0" style="margin-left: auto; margin-right: auto; border-collapse: separate; border-spacing: 16px 8px; color:black; table-layout: fixed">
				<!-- アウター -->
				<tr>
					<!-- 画像 -->
					<td><input id="outer_image2" type="image" width="100" height="100"></td>
					<td width="5" valign="top">
						<div style="text-align:center">
							<input type="checkbox" id="outer_fvrt" style="display:none;" value="1" onChange="chageFvrt(this)">
							<div style="font-size: 30px;">
								<label for="outer_fvrt" class="top"><font id="outer_star" color="#c0c0c0">★</font></label>
							</div>
						</div>
					</td>

					<!-- 詳細 -->
					<td>
						<table border="0" style="font-size: 5pt;">
							<tr>
								<td align="left">カテゴリー</td>
								<td>:</td>
								<td>アウター</td>
							</tr>
							<tr>
								<td align="left">サブカテゴリー</td>
								<td>:</td>
								<td id="outer_sub"></td>
							</tr>
							<tr>
								<td align="left">カラー</td>
								<td>:</td>
								<td id="outer_color"></td>
							</tr>
							<tr>
								<td align="left">パターン</td>
								<td>:</td>
								<td id="outer_design"></td>
							</tr>
							<tr>
								<td align="left">サイズ</td>
								<td>:</td>
								<td id="outer_size"></td>
							</tr>
						</table>
					</td>
				</tr>

				<!-- トップス -->
				<tr>
					<!-- 画像 -->
					<td><input id="tops_image2" type="image" width="100" height="100"></td>
					<td width="5" valign="top">
						<div style="text-align: center">
							<input type="checkbox" id="tops_fvrt" style="display:none;" value="1" onChange="chageFvrt(this)">
							<div style="font-size: 30px;">
								<label for="tops_fvrt" class="top"><font id="tops_star" color="#c0c0c0">★</font></label>
							</div>
						</div>
					</td>
					<!-- 詳細 -->
					<td>
						<table border="0" style="font-size: 5pt">
							<tr>
								<td align="left">カテゴリー</td>
								<td>:</td>
								<td>トップス</td>
							</tr>
							<tr>
								<td align="left">サブカテゴリー</td>
								<td>:</td>
								<td id="tops_sub"></td>
							</tr>
							<tr>
								<td align="left">カラー</td>
								<td>:</td>
								<td id="tops_color"></td>
							</tr>
							<tr>
								<td align="left">パターン</td>
								<td>:</td>
								<td id="tops_design"></td>
							</tr>
							<tr>
								<td align="left">サイズ</td>
								<td>:</td>
								<td id="tops_size"></td>
							</tr>
						</table>
					</td>
				</tr>

				<!-- ボトムス-->
				<tr>
					<!-- 画像 -->
					<td><input id="bottoms_image2" type="image" width="100" height="100"></td>
					<td width="5" valign="top">
						<div style="text-align: center">
							<input type="checkbox" id="bottoms_fvrt" style="display:none;" value="1" onChange="chageFvrt(this)">
							<div style="font-size: 30px;">
								<label for="bottoms_fvrt" class="top"><font id="bottoms_star" color="#c0c0c0">★</font></label>
							</div>
						</div>
					</td>
					<!-- 詳細 -->
					<td>
						<table border="0" style="font-size: 5pt">
							<tr>
								<td align="left">カテゴリー</td>
								<td>:</td>
								<td>ボトムス</td>
							</tr>
							<tr>
								<td align="left">サブカテゴリー</td>
								<td>:</td>
								<td id="bottoms_sub"></td>
							</tr>
							<tr>
								<td align="left">カラー</td>
								<td>:</td>
								<td id="bottoms_color"></td>
							</tr>
							<tr>
								<td align="left">パターン</td>
								<td>:</td>
								<td id="bottoms_design"></td>
							</tr>
							<tr>
								<td align="left">サイズ</td>
								<td>:</td>
								<td id="bottoms_size"></td>
							</tr>
						</table>
					</td>
				</tr>

				<!-- 靴 -->
				<tr>
					<!-- 画像 -->
					<td><input id="shoes_image2" type="image" width="100" height="100"></td>
					<td width="5" valign="top">
						<div style="text-align: center">
							<input type="checkbox" id="shoes_fvrt" style="display:none;" value="1" onChange="chageFvrt(this)">
							<div style="font-size: 30px;">
								<label for="shoes_fvrt" class="top"><font id="shoes_star" color="#c0c0c0">★</font></label>
							</div>
						</div>
					</td>
					<!-- 詳細 -->
					<td>
						<table border="0" style="font-size: 5pt">
							<tr>
								<td align="left">カテゴリー</td>
								<td>:</td>
								<td>シューズ</td>
							</tr>
							<tr>
								<td align="left">サブカテゴリー</td>
								<td>:</td>
								<td id="shoes_sub"></td>
							</tr>
							<tr>
								<td align="left">カラー</td>
								<td>:</td>
								<td id="shoes_color"></td>
							</tr>
							<tr>
								<td align="left">パターン</td>
								<td>:
									<td id="shoes_design"></td>
							</tr>
							<tr>
								<td align="left">サイズ</td>
								<td>:</td>
								<td id="shoes_size"></td>
							</tr>
						</table>
						</td>
				</tr>
			</table>

		</div>

	</body>

	<script>
		// コーディネート画面から送信されたobjectId
  var objectId;

  // お気に入りコーディネートのobjectId
  var crdntObjectId;

  //  コーディネートのお気に入りフラグ変更
  function changeCoordinateFvrt(){

    // データベースに接続
    var fvrtCrdnts = ncmb.DataStore("fvrtCrdnt");

    var flag = document.getElementById("coordinatefvrtFlg").value;
    if(flag == 1){
      document.getElementById("coordinateStar").color = '#ffff00';
      document.getElementById("coordinatefvrtFlg").value = 0;
      console.log('お気に入りフラグ(コーディネート) true：' + flag);

      // TODO:お気に入りコーディネートの登録
      fvrtCrdnts.set("item1_objId", objectId[0])
                .set("item2_objId", objectId[1])
                .set("item3_objId", objectId[2])
                .set("item4_objId", objectId[3])
                .save()
                .then(function(fvrtRes){
                  // 登録log
                  console.log("fvrtCrdnt Inserted!");
                  
                  // TODO:登録したコーディネートのobjectId取得
                  fvrtCrdnts.equalTo("item1_objId", objectId[0])
                            .equalTo("item2_objId", objectId[1])
                            .equalTo("item3_objId", objectId[2])
                            .equalTo("item4_objId", objectId[3])
                            .fetchAll()
                            .then(function(res){
                              console.log("Successfully retrieved");
                              crdntObjectId = res[0].get("objectId");
                            }).catch(function(err){
                              // エラー処理
                              console.log("Err#" + err.code +": " +err.message);  
                            });
                }).catch(function(err){
                  // エラー処理
                  console.log("Err#" + err.code +": " +err.message);   
                });

    } else {
      document.getElementById("coordinateStar").color = '#c0c0c0';
      document.getElementById("coordinatefvrtFlg").value = 1;
      console.log('お気に入りフラグ(コーディネート) false：' + flag);

      // TODO:お気に入りコーディネートの削除
      fvrtCrdnts.equalTo("item1_objId", objectId[0])
                .delete()
                .then(function(res){
                  console.log("Successfully Delete!");
                 } ).catch(function(err){
                    // エラー処理
                    console.log("Err#" + err.code +": " +err.message);  
                  });
    }
  }

  // アイテム一覧のお気に入りフラグ変更
  function chageFvrt(e){
    
    // データベースに接続
    var items = ncmb.DataStore("item");

    // 選択されたＩＤ取得
    var id = e.id;

    // itemインデックス
    var itemIdx = 0;

    var flag = 0;

    if('outer_fvrt' === id){
      flag =  document.getElementById("outer_fvrt").value;
      itemIdx = 0;
      if(flag == 1){
        document.getElementById("outer_star").color = '#ffff00';
        document.getElementById("outer_fvrt").value = 0;
        console.log('お気に入りフラグ(outer) true：' + flag);
      } else {
        document.getElementById("outer_star").color = '#c0c0c0';
        document.getElementById("outer_fvrt").value = 1;
        console.log('お気に入りフラグ(outer) false：' + flag);
      }
    } else if('tops_fvrt' === id) {
      flag =  document.getElementById("tops_fvrt").value;
      itemIdx = 1;
      if(flag == 1){
        document.getElementById("tops_star").color = '#ffff00';
        document.getElementById("tops_fvrt").value = 0;
        console.log('お気に入りフラグ(tops) true：' + flag);
      } else {
        document.getElementById("tops_star").color = '#c0c0c0';
        document.getElementById("tops_fvrt").value = 1;
        console.log('お気に入りフラグ(tops) false：' + flag);
      }
    } else if('bottoms_fvrt' === id) {
      flag =  document.getElementById("bottoms_fvrt").value;
      itemIdx = 2;
      if(flag == 1){
        document.getElementById("bottoms_star").color = '#ffff00';
        document.getElementById("bottoms_fvrt").value = 0;
        console.log('お気に入りフラグ(bottoms) true：' + flag);
      } else {
        document.getElementById("bottoms_star").color = '#c0c0c0';
        document.getElementById("bottoms_fvrt").value = 1;
        console.log('お気に入りフラグ(bottoms) false：' + flag);
      }
    } else if('shoes_fvrt' === id) {
      flag =  document.getElementById("shoes_fvrt").value;
      itemIdx = 3;
      if(flag == 1){
        document.getElementById("shoes_star").color = '#ffff00';
        document.getElementById("shoes_fvrt").value = 0;
        console.log('お気に入りフラグ(shoes) true：' + flag);
      } else {
        document.getElementById("shoes_star").color = '#c0c0c0';
        document.getElementById("shoes_fvrt").value = 1;
        console.log('お気に入りフラグ(shoes) false：' + flag);
      }
    }

    // テーブルの更新
    items.equalTo("objectId", objectId[itemIdx])
        .fetchAll()
        .then(function(results){
          // object取得
          var item = results[0];
          item.set("fvrtFlg", flag);
          return item.update();
        })
        .catch(function(err){
          // エラー処理
          console.log("Err#" + err.code +": " +err.message);
        });
  }

  // 画面表示時
  ons.getScriptPage().onShow = function() {
    
    console.log("コーディネート詳細画面:onShow");

    // データベースに接続
    var items = ncmb.DataStore("item");
    var fvrtCrdnts = ncmb.DataStore("fvrtCrdnt");

    // コーディネート画面から送信されたデータを取得
    objectId = this.data.objectIdArr;

    // 出力するアイテムの順番
    var CATEGORY = ["tops", "bottoms", "outer", "shoes"];

    // カウント変数
    var idx = 0;

    // コーディネートのお気に入り確認
    fvrtCrdnts.equalTo("item1_objId", objectId[0])
              .equalTo("item2_objId", objectId[1])
              .equalTo("item3_objId", objectId[2])
              .equalTo("item4_objId", objectId[3])
              .fetchAll()
              .then(function(res){
                console.log("Successfully retrieved");
                if(res.length > 0){
                  document.getElementById("coordinateStar").color = '#c0c0c0';
                  document.getElementById("coordinatefvrtFlg").value = 1;
                } else {
                  // 処理なし
                }
              }).catch(function(err){
                // エラー処理
                console.log("Err#" + err.code +": " +err.message);  
              });

    // コーディネート画像・アイテム一覧の初期設定
    objectId.forEach(
      function(id){
        items.equalTo("objectId", id)
          .fetchAll()
          .then(
            function(results){
              var obj = results[0];
              // コーディネート画像を設定
              document.getElementById(CATEGORY[idx] + "_image").src = (obj.get("image"));
              // ITEM LIST画像を設定
              document.getElementById(CATEGORY[idx] + "_image2").src = (obj.get("image"));
              // 各アイテムの詳細を設定←サブカテゴリのカラム名に自信なし
              document.getElementById(CATEGORY[idx] + "_sub").innerHTML = convert_sub_category(obj.get("category"),obj.get("subcategory"));
              document.getElementById(CATEGORY[idx] + "_color").innerHTML = convert_color(obj.get("color"));document.getElementById(CATEGORY[idx] + "_design").innerHTML = convert_design(obj.get("design"));document.getElementById(CATEGORY[idx] + "_size").innerHTML = convert_size(obj.get("size"));

              // 各アイテムのお気に入りフラグを設定
             if(obj.get("fvrtFlg") == "1"){
               document.getElementById(CATEGORY[idx] + "_star").color = '#ffff00';
               document.getElementById(CATEGORY[idx] + "_fvrt").value = 0;
             } else {
               document.getElementById(CATEGORY[idx] + "_star").color = '#c0c0c0';
               document.getElementById(CATEGORY[idx] + "_fvrt").value = 1;
             }
            })
          .catch(
            function(err){
              console.log(err);
            }
          );

        idx = idx + 1;
      }
    );
  }
	</script>

</ons-page>