<ons-page id="coordinate">

	<head>
		<ons-toolbar>
			<div class="left">
				<ons-back-button>Back</ons-back-button>
			</div>
			<div class="center">
				<ons-icon icon="user-circle"></ons-icon>コーディネート</div>
		</ons-toolbar>
	</head>

	<body>


		<div id="coordinate" ＞ <br>


			<div>
				<p class="box" style="border-bottom: 2px solid blue; color: navy; border-color:navy; text-align:center;">

					<font size="5"> コーデＡ </font>
				</p>

				<a onClick="send_coordinateDtl_A()">
					<table border="0" style="margin-left: auto; margin-right: auto;">
						<tr>
							<td colspan="1" rowspan="2">
								<!-- トップス -->
								<!-- <input id="tops_image_1" type="image" src="/image/1_1.png"  width="100" height="100"> -->
								<img src="image/1_1_pink.png" id='tops_image_1' alt="トップスの画像" style="float:left;" width="100px" height="100px">
							</td>
							<td colspan="1" rowspan="3">
								<!-- アウター -->
								<!-- <input id="outer_image_1" type="image" src="/image/3_1.png"  width="100" height="100"> -->
								<img src="image/3_1_blue.png" id='outer_image_1' alt="アウターの画像" style="float:left;" width="100px" height="100px">
							</td>
						</tr>
						<tr></tr>
						<tr>
							<td colspan="1" rowspan="2">
								<!-- ボトムス -->
								<!-- <input id="bottoms_image_1" type="image" src="/image/2_1.png"  width="100" height="100"> -->
								<img src="image/2_6_blue.png" id='bottoms_image_1' alt="ボトムスの画像" style="float:left;" width="100px" height="100px">
							</td>
						</tr>
						<tr>
							<td colspan="1" rowspan="3"></td>
						</tr>
						<tr>
							<td colspan="1" rowspan="2">
								<!-- 靴 -->
								<!-- <input id="shoes_image_1" type="image" src="/image/5_7.png"  width="100" height="100"> -->
								<img src="image/5_5_red.png" id='shoes_image_1' alt="シューズの画像" style="float:left;" width="100px" height="100px">
							</td>
						</tr>
					</table>
				</a>
			</div>

			<div>
				<p class="box" style="border-bottom: 2px solid blue; color: navy; border-color:navy; text-align:center;">
					<font size="5"> コーデB </font>
				</p>
				<a onClick="send_coordinateDtl_B()">

					<table border="0" style="margin-left: auto; margin-right: auto;">
						<tr>
							<td colspan="1" rowspan="2">
								<!-- トップス -->
								<img src="image/1_1_pink.png" id='tops_image_2' alt="トップスの画像" style="float:left;" width="100px" height="100px">
							</td>
							<td colspan="1" rowspan="3">
								<!-- アウター -->
								<img src="image/3_1_blue.png" id='outer_image_2' alt="アウターの画像" style="float:left;" width="100px" height="100px">
							</td>
						</tr>
						<tr></tr>
						<tr>
							<td colspan="1" rowspan="2">
								<!-- ボトムス -->
								<img src="image/2_6_blue.png" id='bottoms_image_2' alt="ボトムスの画像" style="float:left;" width="100px" height="100px">
							</td>
						</tr>
						<tr>
							<td colspan="1" rowspan="3"></td>
						</tr>
						<tr>
							<td colspan="1" rowspan="2">
								<!-- 靴 -->
								<img src="image/5_5_red.png" id='shoes_image_2' alt="シューズの画像" style="float:left;" width="100px" height="100px">
							</td>
						</tr>
					</table>
				</a>

			</div>

			<div>
				<p class="box" style="border-bottom: 2px solid blue; color: navy; border-color:navy; text-align:center;">
					<font size="5"> コーデC </font>
				</p>
				<a onClick="send_coordinateDtl_C()">
					<table border="0" style="margin-left: auto; margin-right: auto;">
						<tr>
							<td colspan="1" rowspan="2">
								<!-- トップス -->
								<img src="image/1_1_pink.png" id='tops_image_3' alt="トップスの画像" style="float:left;" width="100px" height="100px">
							</td>
							<td colspan="1" rowspan="3">
								<!-- アウター -->
								<img src="image/3_1_blue.png" id='outer_image_3' alt="アウターの画像" style="float:left;" width="100px" height="100px">
							</td>
						</tr>
						<tr></tr>
						<tr>
							<td colspan="1" rowspan="2">
								<!-- ボトムス -->
								<img src="image/2_6_blue.png" id='bottoms_image_3' alt="ボトムスの画像" style="float:left;" width="100px" height="100px">
							</td>
						</tr>
						<tr>
							<td colspan="1" rowspan="3"></td>
						</tr>
						<tr>
							<td colspan="1" rowspan="2">
								<!-- 靴 -->
								<img src="image/5_5_red.png" id='shoes_image_3' alt="シューズの画像" style="float:left;" width="100px" height="100px">
							</td>
						</tr>
					</table>
				</a>

			</div>

		</div>

		<br>



	</body>

	<script>
		// カテゴリーの項目
    var categories = [
      "トップス","ボトムス","アウター","ワンピース","シューズ"
    ];
    
    // サブカテゴリーの項目
    var sub_categories = [
      ["Tシャツ","ポロシャツ","パーカー","ニット","インナー"],
      ["ワイドパンツ","スキニー","ミニスカート","ロングスカート","ショートパンツ"],
      ["ジャケット","ダウンコード","カーディガン","ブルゾン","ライダース"],
      ["ニットワンピース（ミニ）","ニットワンピース（ロング）","シャツワンピース（ミニ）","シャツワンピース（ロング）"],
      ["スニーカー","サンダル","ロングブーツ","ショートブーツ","ヒールパンプス","フラットパンプス","ローファー"]
    ];

    // 柄項目
    var designs = ["無地","水玉(ドット)","ストライプ","ボーダー","チェック","ペイズリー","迷彩","アニマル"
    ];

    // カラー項目
    var colors = [
      "赤","茶","橙","黄","緑","青","紫","黒","白","桃","グレー","ベージュ" 
    ];
    // カラー業務コード順(業務コードできたら変える)
    var colors_gyomu = [
      "dummy","ブラック","ホワイト","グレー","カーキ","ネイビー","ブラウン","ベージュ","レッド","オレンジ","イエロー","グリーン","ブルー","パープル","ピンク","その他"
    ];

    // サイズ項目
    var sizes = [ 
      "XS","S","M","L","XL","XXL","3XL"
    ];    

    var items = ncmb.DataStore("item");
    var objectId_tops_A = ""
    var objectId_bottoms_A = ""
    var objectId_outer_A = ""
    var objectId_shoes_A = ""
    var objectId_tops_B = ""
    var objectId_bottoms_B = ""
    var objectId_outer_B = ""
    var objectId_shoes_B = ""
    var objectId_tops_C = ""
    var objectId_bottoms_C = ""
    var objectId_outer_C = ""
    var objectId_shoes_C = ""
    // 画面表示時
    ons.getScriptPage().onShow = function() {
    console.log("onShow cordhinate"+ getSeason())

    // var objectId = this.data.objectId;
     coordinateAboutSeason();

      // items.equalTo("category", "1")
      //    .fetchAll()
      //    .then(function(results){
      //      // 配列からランダムで値を選択
      //  var object = results[ Math.floor( Math.random() * results.length ) ] ;
      //       // for (var i = 0; i < results.length; i++) {
      //       //   var object = results[i];
      //         document.getElementById("tops_image_1").src=(object.get("image"));
      //         document.getElementById("tops_image_2").src=(object.get("image"));
      //         document.getElementById("tops_image_3").src=(object.get("image"));
      //    })
      //     .catch(function(err){
      //       console.log(err);
      //     });
    
      // items.equalTo("category", "2")
      //    .fetchAll()
      //    .then(function(results){
      //      // 配列からランダムで値を選択
      //  var object = results[ Math.floor( Math.random() * results.length ) ] ;
      //       // for (var i = 0; i < results.length; i++) {
      //       //   var object = results[i];
      //          document.getElementById("bottoms_image_1").src=(object.get("image"));          
      //          document.getElementById("bottoms_image_2").src=(object.get("image"));          
      //          document.getElementById("bottoms_image_3").src=(object.get("image"));          
      //     })
      //     .catch(function(err){
      //       console.log(err);
      //     })
      // items.equalTo("category", "3")
      //    .fetchAll()
      //    .then(function(results){
      //      // 配列からランダムで値を選択
      //  var object = results[ Math.floor( Math.random() * results.length ) ] ;
      //       // for (var i = 0; i < results.length; i++) {
      //       //   var object = results[i];
      //          document.getElementById("outer_image_1").src=(object.get("image"));        
      //          document.getElementById("outer_image_2").src=(object.get("image"));        
      //          document.getElementById("outer_image_3").src=(object.get("image"));        
      //     })
      //     .catch(function(err){
      //       console.log(err);
      //     });    
      // items.equalTo("category", "5")
      //    .fetchAll()
      //    .then(function(results){
      //      // 配列からランダムで値を選択
      //  var object = results[ Math.floor( Math.random() * results.length ) ] ;
      //       // for (var i = 0; i < results.length; i++) {
      //       //   var object = results[i];
      //         document.getElementById("shoes_image_1").src=(object.get("image"));
      //         document.getElementById("shoes_image_2").src=(object.get("image"));
      //         document.getElementById("shoes_image_3").src=(object.get("image"));
      //     })
      //    .catch(function(err){
      //       console.log(err);
      //     });
          // showSelectItem(objectId)
    }

    // itemSelect画面へ
    function send_itemSelect(){
      document.getElementById('nav').pushPage('itemSelect.html', {});
    }; 

      function showSelectItem(objectId){
        
         console.log("coordinate :" + objectId);

         items.equalTo("objectId", objectId)
         .fetchAll()
         .then(function(results){
           // 配列からランダムで値を選択
       var object = results[0] ;
              var category=object.get("category")
              var strCategory
              switch(category){
                case "1":
                  strCategory="tops"
                  break
                case "2":
                  strCategory="bottoms"
                  break
                case "3":
                  strCategory="outer"
                  break
                case "4":
                  strCategory="one_piece"
                  break
                case "5":
                  strCategory="shoes"
                  break        
              }
              document.getElementById(strCategory+"_category").innerHTML=categories[object.get("category")-1]
              document.getElementById(strCategory+"_sub_category").innerHTML=sub_categories[object.get("category")-1][object.get("sub_category")-1]
              document.getElementById(strCategory+"_color").innerHTML=colors[object.get("color")-1]
              document.getElementById(strCategory+"_design").innerHTML=designs[object.get("design")-1]
              document.getElementById(strCategory+"_size").innerHTML=sizes[object.get("size")-1]
              document.getElementById(strCategory+"_image").src=(object.get("image"));
          })
         .catch(function(err){
            console.log(err);
          });

      }

      // コーディネート詳細画面Aへの遷移
      function send_coordinateDtl_A(){
        console.log("objectId_tops_A," + objectId_tops_A)
        console.log("objectId_bottoms_A," + objectId_bottoms_A)
        console.log("objectId_outer_A," + objectId_outer_A)
        console.log("objectId_shoes_A," + objectId_shoes_A)
        send_coordinateDtl(objectId_tops_A,objectId_bottoms_A,objectId_outer_A,objectId_shoes_A)
      };
      
      // コーディネート詳細画面Bへの遷移
      function send_coordinateDtl_B(){
        document.getElementById('nav').pushPage('coordinateDtl.html', {});
      };
      // コーディネート詳細画面Cへの遷移
      function send_coordinateDtl_C(){
        document.getElementById('nav').pushPage('coordinateDtl.html', {});
      };
      function send_coordinateDtl(objectId_tops,objectId_bottoms,objectId_outer,objectId_shoes){
        document.getElementById('nav').pushPage('coordinateDtl.html', {
          data:{objectId_tops,objectId_bottoms,objectId_outer,objectId_shoes}
        });

      }

      // 現在月から季節を取得
      function getSeason(){
        var now = new Date();
        // 現在月(値的には-1したものが返却される。1月の場合は0,12月の場合は11)
        var wkMonth = now.getMonth(); 
        switch (wkMonth) {
          // 春(3~5月)
          case 2:
          case 3:
          case 4:
               return 1
          // 夏(6~8月)
          case 5:
          case 6:
          case 7:
               return 2
          // 秋(9~11月)
          case 8:
          case 9:
          case 10:
               return 3
          // 冬(12~2月)
          case 11:
          case 0:
          case 1:
               return 4
            break
          default:
            console.log('エラー')
        }
        return 9
      }
            var result_tops = new Array()
            var result_bottoms = new Array()
            var result_outer = new Array()
            var result_shoes = new Array()
            var object
            var combinationArray = new Array() // {点数,アウター,トップス,ボトムス}でまとめる

      // 季節を考慮したコーディネート
      function coordinateAboutSeason(){
        // 今の季節に一致したアイテムをカテゴリ順で全取得
        var currentSeason = getSeason()
        // カテゴリの全組み合わせを算出
        items.equalTo("season",String(currentSeason)).order("category",false)
          .fetchAll()
          .then(function(results){
            // カテゴリごとに配列にわける
              for (var i = 0; i < results.length; i++) {
                object = results[i];
                switch (String(object.get("category"))) {
                  // トップス
                  case "1":
                      result_tops.push(object)
                      break
                  // ボトムス
                  case "2":
                      result_bottoms.push(object)
                    break
                  // アウター
                  case "3":
                      result_outer.push(object)
                    break
                  // シューズ
                  case "5":
                      result_shoes.push(object)
                    break
                  default:
                    console.log('エラー')
                }
              }
              console.log("tops count:" + result_tops.length)
              console.log("bottom count:" + result_bottoms.length)
              console.log("outer count:" + result_outer.length)
              console.log("shoes count" + result_shoes.length)
              

              // 色による配点を行う
              for(var i_top = 0;i_top < result_tops.length; i_top++){
                for(var i_outer = 0;i_outer < result_outer.length; i_outer++){
                  for(var i_bottom = 0;i_bottom < result_bottoms.length; i_bottom++){
                    // 全パターンで色採点
                    var wkStr = ""
                    wkStr = allocationColor(result_outer[i_outer].get("color"),result_tops[i_top].get("color"),result_bottoms[i_bottom].get("color"))
                    wkStr = wkStr + "," + i_outer + "," + i_top + "," + i_bottom
                    console.log(wkStr)
                    combinationArray.push(wkStr)
                  }
                }
              }

              var showItemCounter = 0
              // 採点した組み合わせを降順にソート
              if(combinationArray.length != 0 ){

                combinationArray.sort()
                combinationArray.reverse()
                console.log("季節考慮したソート後のcombinationArray" + combinationArray)
                console.log("季節考慮したソート後のcombinationArray.lenght" + combinationArray.length)
                for(var i = 1;i < combinationArray.length+1; i++){
                  // 上位3位を提案する
                  var result = combinationArray[i - 1].split(",")
                  console.log(i + "位!!" + combinationArray[i-1])
                  
                  document.getElementById("tops_image_" + i.toString()).src=(result_tops[result[2]].get("image"));
                  document.getElementById("bottoms_image_" + i.toString()).src=(result_bottoms[result[3]].get("image"));
                  document.getElementById("outer_image_" + i.toString()).src=(result_outer[result[1]].get("image"));
                  var randomShoesIndex = Math.floor(Math.random() * result_shoes.length)
                  document.getElementById("shoes_image_" + i.toString()).src=(result_shoes[randomShoesIndex].get("image"));
                  showItemCounter = i

                  if (i == 1){
                    setObjectItems_A(result,randomShoesIndex)
                  } else if(i == 2){
                    setObjectItems_B(result,randomShoesIndex)
                  } else if(i ==3){
                    setObjectItems_C(result,randomShoesIndex)
                  } else if(i == 4){
                    break 
                  }
                }                
              }

              // 季節に合った提案が3つ未満の場合
              if(showItemCounter < 3){
                coordinateNonAboutSeason(showItemCounter)
              }

              
            })
          .catch(function(err){
              console.log(err);
            });
      }
      function setObjectItems_A(argResultArray,randomShoesIndex){
        objectId_tops_A = result_tops[argResultArray[2]].get("objectId")
        objectId_bottoms_A = result_bottoms[argResultArray[3]].get("objectId")
        objectId_outer_A = result_outer[argResultArray[1]].get("objectId")
        objectId_shoes_A = result_shoes[randomShoesIndex].get("objectId")
      }
      function setObjectItems_B(argResultArray,randomShoesIndex){
        objectId_tops_B = result_tops[argResultArray[2]].get("objectId")
        objectId_bottoms_B = result_bottoms[argResultArray[3]].get("objectId")
        objectId_outer_B = result_outer[argResultArray[1]].get("objectId")
        objectId_shoes_B = result_shoes[randomShoesIndex].get("objectId")
      }
      function setObjectItems_C(argResultArray,randomShoesIndex){
        objectId_tops_C = result_tops[argResultArray[2]].get("objectId")
        objectId_bottoms_C = result_bottoms[argResultArray[3]].get("objectId")
        objectId_outer_C = result_outer[argResultArray[1]].get("objectId")
        objectId_shoes_C = result_shoes[randomShoesIndex].get("objectId")
      }

      // 季節を考慮しないコーディネート
      function coordinateNonAboutSeason(showCount){
            result_tops = new Array()
            result_bottoms = new Array()
            result_outer = new Array()
            result_shoes = new Array()
            combinationArray = new Array()
            console.log("季節を考慮しないコーディネート showCount:" + showCount)

        // カテゴリの全組み合わせを算出
        items.order("category",false)
          .fetchAll()
          .then(function(results){
            // カテゴリごとに配列にわける
              for (var i = 0; i < results.length; i++) {
                object = results[i];
                      console.log("category:" + object.get("category"))
                switch (String(object.get("category"))) {
                  // トップス
                  case "1":
                      result_tops.push(object)
                      break
                  // ボトムス
                  case "2":
                      result_bottoms.push(object)
                    break
                  // アウター
                  case "3":
                      result_outer.push(object)
                    break
                  // シューズ
                  case "5":
                      result_shoes.push(object)
                    break
                  default:
                    console.log('エラー')
                }
              }
              console.log("tops count:" + result_tops.length)
              console.log("bottom count:" + result_bottoms.length)
              console.log("outer count:" + result_outer.length)
              console.log("shoes count" + result_shoes.length)

              // 色による配点を行う
              for(var i_top = 0;i_top < result_tops.length; i_top++){
                for(var i_outer = 0;i_outer < result_outer.length; i_outer++){
                  for(var i_bottom = 0;i_bottom < result_bottoms.length; i_bottom++){
                    // 全パターンで色採点
                    var wkStr = ""
                    wkStr = allocationColor(result_outer[i_outer].get("color"),result_tops[i_top].get("color"),result_bottoms[i_bottom].get("color"))
                    wkStr = wkStr + "," + i_outer + "," + i_top + "," + i_bottom
                    console.log(wkStr)
                    combinationArray.push(wkStr)
                  }
                }
              }
              // 採点した組み合わせを降順にソート
              combinationArray.sort()
              combinationArray.reverse()
              console.log("季節考慮しないソート後のcombinationArray" + combinationArray)
              console.log("季節考慮しないソート後のcombinationArray.lenght" + combinationArray.length)


              for(var i = 1;i < combinationArray.length + 1; i++){
                // 上位3位を提案する
                var result = combinationArray[i - 1].split(",")
                console.log(i + Number(showCount) + "位!!" + combinationArray[i-1])
                document.getElementById("tops_image_" + (i + Number(showCount)).toString()).src=(result_tops[result[2]].get("image"));
                document.getElementById("bottoms_image_" + (i + Number(showCount)).toString()).src=(result_bottoms[result[3]].get("image"));
                document.getElementById("outer_image_" + (i + Number(showCount)).toString()).src=(result_outer[result[1]].get("image"));

                var randomShoesIndex = Math.floor(Math.random() * result_shoes.length)
                document.getElementById("shoes_image_" + (i + Number(showCount)).toString()).src=(result_shoes[randomShoesIndex].get("image"));
                 if (i == i + Number(showCount)){
                    setObjectItems_A(result,randomShoesIndex)
                  } else if(i == i + Number(showCount)){
                    setObjectItems_B(result,randomShoesIndex)
                  } else if(i ==i + Number(showCount)){
                    setObjectItems_C(result,randomShoesIndex)
                  } else if(i == 4){
                    break 
                  }
              }
            })
          .catch(function(err){
              console.log(err);
            });
      }


      // 色配点
      function allocationColor(outer_i,top_i,bottom_i){
        console.log("allocationColor:" + outer_i + "," + top_i + "," + bottom_i)
        // ①王道パターン判定
        if(noDoubtPattern(outer_i,top_i,bottom_i)){
          console.log("王道パターンやぁ!!")
          return "30"
        }else {
          console.log("王道パターンやない...")
        }

        // ②基準色による判定(白,黒,グレー,ベージュ,ネイビー,カーキ)
        const basicColor = ["1","2","3","4","5","7"]
        if(basicColor.indexOf(top_i) !== -1 && basicColor.indexOf(outer_i) !== -1 && basicColor.indexOf(bottom_i) !== -1){
          console.log("Basic色、はいってます")
          return "20"          
        }
        // ③残りの色の組み合わせ
        console.log("残り物の色、入ってます")
        return "10"
      }
      // 王道10パターン
      function noDoubtPattern(outerColor,topsColor,bottomsColor){
        console.log("outer:"+colors_gyomu[outerColor]+" ,tops:"+colors_gyomu[topsColor]+" ,bottoms:"+colors_gyomu[bottomsColor])
        // アウター	トップス	ボトムス
        // 白 白 黒
        if(outerColor == 2 && topsColor == 2 && bottomsColor == 1){
          return true

        // グレー グレー 黒
        } else if(outerColor == 3 && topsColor == 3 && bottomsColor == 1){
          return true

        // 黒 黒 白
        } else if(outerColor == 1 && topsColor == 1 && bottomsColor == 2){
          return true

        // グレー 白 黒
        } else if(outerColor == 3 && topsColor == 2 && bottomsColor == 1){
          return true

        // 黒 白 グレー
        } else if(outerColor == 1 && topsColor == 2 && bottomsColor == 3){
          return true

        // ネイビー 白 黒
        } else if(outerColor == 5 && topsColor == 2 && bottomsColor == 1){
          return true

        // ベージュ 白 黒
        } else if(outerColor == 7 && topsColor == 2 && bottomsColor == 1){
          return true

        // 白 白 カーキ
        } else if(outerColor == 2 && topsColor == 2 && bottomsColor == 4){
          return true

        // カーキ 白 黒
        } else if(outerColor == 4 && topsColor == 2 && bottomsColor == 1){
          return true

        // カーキ 白 グレー
        } else if(outerColor == 4 && topsColor == 2 && bottomsColor == 3){
          return true
        }
        return false
      }
	</script>
</ons-page>